use master;
go
use DataWarehouse;

-- create table for silver layer -- 

IF OBJECT_ID('silver.crm_cust_info1','U') IS NOT NULL  -- U for user and creating table related to customer information--
	DROP TABLE silver.crm_cust_info1 ;

CREATE TABLE silver.crm_cust_info1 (
	cst_id INT,
	cst_key NVARCHAR(50),
	cst_firstname NVARCHAR(50),
	cst_lastname NVARCHAR(50),
	cst_marital_status NVARCHAR(50),
	cst_gndr NVARCHAR(50),
	cst_create_date NVARCHAR(50), -- if the column has date we cannot directly add date datatype, instead use NVARCHAR--
	);

IF OBJECT_ID('silver.crm_prd_info1','U') IS NOT NULL  -- U for user and creating table related to product information--
	DROP TABLE silver.crm_prd_info1 ;

CREATE TABLE silver.crm_prd_info1 (
	prd_id INT,
	prd_key NVARCHAR(50),
	prd_nm NVARCHAR(50),
	prd_cost INT,
	prd_line NVARCHAR(50),
	prd_start_dt NVARCHAR(50), -- if the column has date we cannot directly add date datatype, instead use NVARCHAR--
	prd_end_dt NVARCHAR(50)     -- if the column has date we cannot directly add date datatype, instead use NVARCHAR--
	);

IF OBJECT_ID('bronze.crm_sales_details','U') IS NOT NULL  -- U for user and creating table related to sales information--
	DROP TABLE bronze.crm_sales_details ;

CREATE TABLE bronze.crm_sales_details (
	sls_ord_num NVARCHAR(50),
	sls_prd_key NVARCHAR(50),
	sls_cust_id INT,
	sls_order_dt NVARCHAR(50),    -- if the column has date we cannot directly add date datatype, instead use NVARCHAR--
	sls_ship_dt NVARCHAR(50),     -- if the column has date we cannot directly add date datatype, instead use NVARCHAR--
	sls_due_dt NVARCHAR(50),      -- if the column has date we cannot directly add date datatype, instead use NVARCHAR--
	sls_sales INT,
	sls_quantity INT,
	sls_price INT
	);

IF OBJECT_ID('silver.erp_loc_a101','U') IS NOT NULL  -- U for user and creating table related to custID& Country information--
	DROP TABLE silver.erp_loc_a101;

CREATE TABLE silver.erp_loc_a101 (
	cid NVARCHAR(50),
	cntry NVARCHAR(50)   -- table with no date -- 
	);

IF OBJECT_ID('silver.erp_cust_az12a','U') IS NOT NULL  -- U for user and creating table related to custID & bday information--
	DROP TABLE silver.erp_cust_az12a;

CREATE TABLE silver.erp_cust_az12a (
	cid NVARCHAR(50),
	bdate NVARCHAR(50),   -- if the column has date we cannot directly add date datatype, instead use NVARCHAR
	gen NVARCHAR(50)
	);
	
IF OBJECT_ID('silver.px_cat_g1v2','U') IS NOT NULL  -- U for user and creating table related to category information--
	DROP TABLE silver.px_cat_g1v2;

CREATE TABLE silver.px_cat_g1v2 (
	id NVARCHAR(50),
	cat NVARCHAR(50),
	subcat NVARCHAR(50),
	maintenance NVARCHAR(50)
	);

TRUNCATE TABLE silver.crm_cust_info1;	
BULK INSERT silver.crm_cust_info1
FROM 'D:\data with bara\datawarehouse\datawarehouse\sql-data-warehouse-project\datasets\source_crm\cust_info.csv'
WITH (
	FIRSTROW = 2,
	FIELDTERMINATOR = ',', -- run the load only once as we may get duplicate rows & columns -- 
	TABLOCK
	);

select * from silver.crm_cust_info1;
select cst_marital_status, count(*) from silver.crm_cust_info
group by cst_marital_status;
select cst_gndr, count(*) from silver.crm_cust_info
group by cst_gndr;

DROP TABLE silver.crm_cust_info;
CREATE TABLE silver.crm_cust_info (
	cst_id INT,
	cst_key NVARCHAR(50),
	cst_firstname NVARCHAR(50),
	cst_lastname NVARCHAR(50),
	cst_marital_status NVARCHAR(50),
	cst_gndr NVARCHAR(50),
	cst_create_date NVARCHAR(50), -- if the column has date we cannot directly add date datatype, instead use NVARCHAR--
	) ;
INSERT INTO silver.crm_cust_info
SELECT
    cst_id,
    cst_key,
    cst_firstname,
    cst_lastname,
    cst_marital_status,
    cst_gndr,
    TRY_CONVERT(DATE, cst_create_date, 105) -- based on the format in the excel we need to use the conversion --
FROM silver.crm_cust_info1;                 -- if we use dd-mm-yyyy format use conversion (TRY_CONVERT(DATE, cst_create_date, 105)--

select * from silver.crm_cust_info;

-- bulk upload of product information -- 
TRUNCATE TABLE silver.crm_prd_info1;	
BULK INSERT silver.crm_prd_info1
FROM 'D:\data with bara\datawarehouse\datawarehouse\sql-data-warehouse-project\datasets\source_crm\prd_info.csv'
WITH (
	FIRSTROW = 2,
	FIELDTERMINATOR = ',', -- run the load only once as we may get duplicate rows & columns -- 
	TABLOCK
	);
select * from silver.crm_prd_info1;

-- bulk upload of sales information -- 
TRUNCATE TABLE bronze.crm_sales_details;	
BULK INSERT bronze.crm_sales_details
FROM 'D:\data with bara\datawarehouse\datawarehouse\sql-data-warehouse-project\datasets\source_crm\sales_details.csv'
WITH (
	FIRSTROW = 2,
	FIELDTERMINATOR = ',', -- run the load only once as we may get duplicate rows & columns -- 
	TABLOCK
	);

	
DROP TABLE silver.crm_prd_info ;
CREATE TABLE silver.crm_prd_info (
	prd_id INT,
	cat_id NVARCHAR(50),
	prd_key NVARCHAR(50),
	prd_nm NVARCHAR(50),
	prd_cost INT,
	prd_line NVARCHAR(50),
	prd_start_dt NVARCHAR(50), -- if the column has date we cannot directly add date datatype, instead use NVARCHAR--
	prd_end_dt NVARCHAR(50)     -- if the column has date we cannot directly add date datatype, instead use NVARCHAR--
	);

TRUNCATE TABLE silver.crm_cust_info;

INSERT INTO silver.crm_prd_info
SELECT
    prd_id,
    prd_key,
    prd_nm,
    prd_cost,
    prd_line,
    TRY_CONVERT(DATE, prd_start_dt, 105),   -- if we use dd-mm-yyyy format use conversion (TRY_CONVERT(DATE, cst_create_date, 105)--
    TRY_CONVERT(DATE, prd_end_dt, 105) -- based on the format in the excel we need to use the conversion --
FROM silver.crm_prd_info1;  

DROP TABLE silver.crm_sales_details;
CREATE TABLE silver.crm_sales_details (
	sls_ord_num NVARCHAR(50),
	sls_prd_key NVARCHAR(50),
	sls_cust_id INT,
	sls_order_dt DATE,    -- if the column has date we cannot directly add date datatype, instead use NVARCHAR--
	sls_ship_dt DATE,     -- if the column has date we cannot directly add date datatype, instead use NVARCHAR--
	sls_due_dt DATE,      -- if the column has date we cannot directly add date datatype, instead use NVARCHAR--
	sls_sales INT,
	sls_quantity INT,
	sls_price INT,
	dwh_create_date datetime2 default getdate()
	);

INSERT INTO silver.crm_sales_details
SELECT
	sls_ord_num ,
	sls_prd_key ,
	sls_cust_id ,
	TRY_CONVERT(DATE, sls_order_dt, 112) ,    -- if the column has date we cannot directly add date datatype, instead use NVARCHAR--
	TRY_CONVERT(DATE, sls_ship_dt, 112) ,     -- if the column has date we cannot directly add date datatype, instead use NVARCHAR--
	TRY_CONVERT(DATE, sls_due_dt, 112) ,      -- if the column has date we cannot directly add date datatype, instead use NVARCHAR--
	sls_sales ,
	sls_quantity ,
	sls_price 
FROM silver.crm_sales_details1;

select * from silver.crm_sales_details;
TRUNCATE TABLE silver.crm_sales_details;

DROP TABLE bronze.erp_cust_az12;
CREATE TABLE bronze.erp_cust_az12 (
	cid NVARCHAR(50),
	bdate NVARCHAR(50),   -- if the column has date we cannot directly add date datatype, instead use NVARCHAR
	gen NVARCHAR(50)
	);

-- bulk upload of customer az12 information -- 
TRUNCATE TABLE bronze.erp_cust_az12;	
BULK INSERT bronze.erp_cust_az12
FROM 'D:\data with bara\datawarehouse\datawarehouse\sql-data-warehouse-project\datasets\source_erp\cust_az12.csv'
WITH (
	FIRSTROW = 2,
	FIELDTERMINATOR = ',', -- run the load only once as we may get duplicate rows & columns -- 
	TABLOCK
	);
select * from silver.erp_cust_az12a;

-- bulk upload of local a101 information -- 
TRUNCATE TABLE silver.erp_loc_a101;	
BULK INSERT silver.erp_loc_a101
FROM 'D:\data with bara\datawarehouse\datawarehouse\sql-data-warehouse-project\datasets\source_erp\loc_a101.csv'
WITH (
	FIRSTROW = 2,
	FIELDTERMINATOR = ',', -- run the load only once as we may get duplicate rows & columns -- 
	TABLOCK
	);
select * from silver.erp_loc_a101;

-- bulk upload of category information -- 
TRUNCATE TABLE silver.px_cat_g1v2;	
BULK INSERT silver.px_cat_g1v2
FROM 'D:\data with bara\datawarehouse\datawarehouse\sql-data-warehouse-project\datasets\source_erp\px_cat_g1v2.csv'
WITH (
	FIRSTROW = 2,
	FIELDTERMINATOR = ',', -- run the load only once as we may get duplicate rows & columns -- 
	TABLOCK
	);
select * from silver.px_cat_g1v2;

INSERT INTO silver.erp_cust_az12
SELECT
	cid,
	TRY_CONVERT(DATE, bdate, 105),   -- if we use dd-mm-yyyy format use conversion (TRY_CONVERT(DATE, cst_create_date, 105)--
	gen
FROM silver.erp_cust_az12a;




ALTER TABLE silver.crm_cust_info
ADD dwh_create_date DATETIME2 NOT NULL DEFAULT SYSDATETIME();

select * from silver.crm_cust_info;

ALTER TABLE silver.crm_prd_info
ADD dwh_create_date DATETIME2 NOT NULL DEFAULT SYSDATETIME();

select * from silver.crm_prd_info;
TRUNCATE TABLE silver.crm_prd_info;
ALTER TABLE silver.crm_sales_details
ADD dwh_create_date DATETIME2 NOT NULL DEFAULT SYSDATETIME();

select * from silver.crm_sales_details;

ALTER TABLE silver.erp_cust_az12
ADD dwh_create_date DATETIME2 NOT NULL DEFAULT SYSDATETIME();

select * from silver.erp_cust_az12;
TRUNCATE TABLE silver.erp_cust_az12;

ALTER TABLE silver.erp_loc_a101
ADD dwh_create_date DATETIME2 NOT NULL DEFAULT SYSDATETIME();

select * from silver.erp_loc_a101;

ALTER TABLE silver.px_cat_g1v2
ADD dwh_create_date DATETIME2 NOT NULL DEFAULT SYSDATETIME();

select * from silver.px_cat_g1v2;

-- load data by cleaning the bronze layer and insert it into silver layer -- 

-- data quality checks -- 

SELECT cst_id , count(*)
FROM bronze.crm_cust_info
group by cst_id
having count(*) > 1;

-- assign unique number to each row -- (ROW_NUMBER) -- hard coding--

SELECT * , ROW_NUMBER() OVER (PARTITION BY cst_id ORDER BY cst_create_date DESC) as FLAG
FROM bronze.crm_cust_info
WHERE cst_id = 29473;

-- common --
SELECT *
FROM
(
SELECT * , ROW_NUMBER() OVER (PARTITION BY cst_id ORDER BY cst_create_date DESC) as FLAG
FROM bronze.crm_cust_info
WHERE cst_id is not null
) t
WHERE FLAG =1;

-- DATA STANDARDIZATION & Consistency --
-- check for unwanted spaces in the string value -- 

SELECT cst_firstname
FROM bronze.crm_cust_info
WHERE cst_firstname != TRIM(cst_firstname);

-- Insert data from bronze to silver --

INSERT INTO silver.crm_cust_info (
	cst_id,
	cst_key,
	cst_firstname,
	cst_lastname,
	cst_marital_status,
	cst_gndr,
	cst_create_date
	)
	SELECT cst_id,
	cst_key,
	TRIM(cst_firstname) as cst_firstname,
	TRIM(cst_lastname) as cst_lastname,
	CASE 
	WHEN UPPER(TRIM(cst_marital_status)) = 'M' THEN 'Married'
	WHEN UPPER(TRIM(cst_marital_status)) = 'S' THEN 'Single'
	ELSE 'N/A'
	END as cst_marital_status,
	CASE 
	WHEN UPPER(TRIM(cst_gndr)) = 'M' THEN 'Male'
	WHEN UPPER(TRIM(cst_gndr)) = 'F' THEN 'Female'
	ELSE 'N/A'
	END as cst_gndr,
	cst_create_date
	FROM 
	(
	SELECT *,
	ROW_NUMBER() OVER(PARTITION BY cst_id ORDER BY cst_create_date DESC) as FLAG
	FROM bronze.crm_cust_info
	WHERE cst_id IS NOT NULL
	)t
	WHERE FLAG = 1;

select * from silver.crm_cust_info;

-- data quality check for PK for product table--

select * from bronze.crm_prd_info;

select prd_id,count(*)
from bronze.crm_prd_info
group by prd_id
having count(*) >1;

-- extracting PK from prd_key -- 

select prd_key, substring(prd_key,1,5) as cat_ID, replace(substring(prd_key,7,len(prd_key)),'-','_') as cat_ID_remaining
from bronze.crm_prd_info;

-- Standardization --
select prd_line,
case upper(trim(prd_line))
when 'M' then 'Mountain'
when 'R' then 'Road'
when 'S' then 'Other Sales'
when 'T' then 'Touring'
else 'N/A'
end as prd_line
from bronze.crm_prd_info;

-- use lead function to access value from the next row within a window -- 

select prd_start_dt,prd_end_dt,lead(prd_start_dt) over(partition by prd_key order by prd_start_dt) as prd_end_dt1
from bronze.crm_prd_info;

SELECT
    prd_start_dt,
    prd_end_dt,
    DATEADD(
        DAY,
        -1,
        LEAD(
            TRY_CONVERT(DATE, prd_start_dt, 120)
        ) OVER (
            PARTITION BY prd_key
            ORDER BY TRY_CONVERT(DATE, prd_start_dt, 120)
        )
    ) AS prd_end_dt1
FROM bronze.crm_prd_info;



select * from bronze.crm_prd_info;
select * from silver.crm_prd_info;

-- complete product data loading into silver table -- 

insert into silver.crm_prd_info 
(
prd_id,
cat_id,
prd_key,
prd_nm,
prd_cost,
prd_line,
prd_start_dt,
prd_end_dt
)
select 
prd_id,
replace(substring(prd_key,1,5),'-','_') as cat_id,
substring(prd_key,7,len(prd_key)) as prd_key,
prd_nm,
ISNULL(prd_cost,0) as prd_cost,
case upper(trim(prd_line))
when 'M' then 'Mountain'
when 'R' then 'Road'
when 'S' then 'Other Sales'
when 'T' then 'Touring'
else 'N/A'
end as prd_line,
cast (prd_start_dt as DATE) as prd_start_dt,
cast(LEAD(prd_start_dt) OVER(PARTITION BY prd_key ORDER BY prd_start_dt)-1 AS DATE) AS prd_end_dt
from bronze.crm_prd_info;


--LEAD(TRY_CONVERT(DATE, prd_start_dt, 120)) OVER (PARTITION BY prd_key ORDER BY TRY_CONVERT(DATE, prd_start_dt, 120))) AS prd_end_dt -- 

INSERT INTO silver.crm_prd_info (
    prd_id,
    cat_id,
    prd_key,
    prd_nm,
    prd_cost,
    prd_line,
    prd_start_dt,
    prd_end_dt
)
SELECT
    prd_id,
    REPLACE(SUBSTRING(prd_key, 1, 5), '-', '_') AS cat_id,  -- Extracted Category ID -- 
    SUBSTRING(prd_key, 7, LEN(prd_key)) AS prd_key,         --Extracted Product Key -- 
    prd_nm,
    ISNULL(prd_cost, 0) AS prd_cost,
    CASE UPPER(TRIM(prd_line))
        WHEN 'M' THEN 'Mountain'
        WHEN 'R' THEN 'Road'
        WHEN 'S' THEN 'Other Sales'
        WHEN 'T' THEN 'Touring'
        ELSE 'N/A'
    END AS prd_line,                 -- Map product line values into descriptive values -- 
    TRY_CONVERT(DATE, prd_start_dt, 120) AS prd_start_dt,
    DATEADD(
        DAY,
        -1,
        LEAD(TRY_CONVERT(DATE, prd_start_dt, 120))
            OVER (PARTITION BY prd_key
                  ORDER BY TRY_CONVERT(DATE, prd_start_dt, 120))
    ) AS prd_end_dt               -- calculate end date as one day before the start date --
FROM bronze.crm_prd_info;

-- data quality check --

select * 
from silver.crm_prd_info
where prd_end_dt < prd_start_dt;



-- using the sales table insert datas -- 

Select * from bronze.crm_sales_details;


select *
from bronze.crm_sales_details
where sls_ord_num <> TRIM(sls_ord_num);

-- 

select *
from bronze.crm_sales_details
where sls_prd_key <> TRIM(sls_prd_key);



select *
from bronze.crm_sales_details
where sls_prd_key NOT IN ( select sls_prd_key from silver.crm_prd_info)


-- inserting the sales data from bronze to silver -- 


INSERT INTO silver.crm_sales_details(
	sls_ord_num ,
	sls_prd_key ,
	sls_cust_id ,
    sls_order_dt,    
	sls_ship_dt,     
	sls_due_dt,     
	sls_sales ,
	sls_quantity ,
	sls_price 
	)
select 
	sls_ord_num,
	sls_prd_key,
	sls_cust_id,
	case 
	when sls_order_dt = 0 or len(sls_order_dt) <> 8 then null -- checking for 0 or null
	else  cast(CAST(sls_order_dt as VARCHAR) as date)  -- Interger is changed to VARCHAR and then to DATE
	end as sls_order_dt,								-- (Interger column cannot be converted into DATE directly)
	case 
	when sls_ship_dt = 0 or len(sls_ship_dt) <> 8 then null
	else  cast(CAST(sls_ship_dt as VARCHAR) as date)
	end as sls_ship_dt,
	case 
	when sls_due_dt = 0 or len(sls_due_dt) <> 8 then null
	else  cast(CAST(sls_due_dt as VARCHAR) as date)
	end as sls_due_dt,
	case
	when sls_sales is null or sls_sales <=0 or sls_sales <> sls_quantity * abs(sls_price)
	then sls_quantity * abs(sls_price)
	else sls_sales
	end as sls_sales,  -- recalculate sales if original value is missing or incorrect
	sls_quantity,
	case
	when sls_price is null or sls_price <=0 
	then sls_sales / nullif(sls_quantity ,0)
	else sls_price
	end as sls_price   -- derive price if original value is invalid -- 
	from bronze.crm_sales_details;

select * from silver.crm_sales_details;


-- now erp customer table --

select * from bronze.erp_cust_az12;

-- to check the duplicate --
select cid,
	case 
	when cid like ('NAS%') THEN substring(cid,4,len(cid))
	else cid
	end as cid,
	bdate,
	gen
	from bronze.erp_cust_az12
	where case 
	when cid like ('NAS%') THEN substring(cid,4,len(cid))
	else cid
	end not in	(select distinct cst_key from silver.crm_cust_info);

-- to insert -- 

select
	case 
	when cid like ('NAS%') THEN substring(cid,4,len(cid))
	else cid
	end as cid,
	CASE
        WHEN TRY_CONVERT(DATE, bdate, 105) > CAST(GETDATE() AS DATE)
            THEN NULL
        ELSE TRY_CONVERT(DATE, bdate, 105)
    END AS bdate_clean,
	case 
	when UPPER(TRIM(gen)) IN ('F', 'FEMALE') then 'Female'
	when UPPER(TRIM(gen)) IN ('M', 'MALE') then 'Male'
	else 'N/A'
	end as gen	
	from bronze.erp_cust_az12;

	-- data standardization and consistency -- 

	select distinct gen
	from bronze.erp_cust_az12;

	select distinct gen,
	case 
	when UPPER(TRIM(gen)) IN ('F', 'FEMALE') then 'Female'
	when UPPER(TRIM(gen)) IN ('M', 'MALE') then 'Male'
	else 'N/A'
	end as gen
	from bronze.erp_cust_az12;




	
