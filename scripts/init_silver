use master;
go
use DataWarehouse;

-- create table for silver layer -- 

IF OBJECT_ID('silver.crm_cust_info1','U') IS NOT NULL  -- U for user and creating table related to customer information--
	DROP TABLE silver.crm_cust_info1 ;

CREATE TABLE silver.crm_cust_info1 (
	cst_id INT,
	cst_key NVARCHAR(50),
	cst_firstname NVARCHAR(50),
	cst_lastname NVARCHAR(50),
	cst_marital_status NVARCHAR(50),
	cst_gndr NVARCHAR(50),
	cst_create_date NVARCHAR(50), -- if the column has date we cannot directly add date datatype, instead use NVARCHAR--
	);

IF OBJECT_ID('silver.crm_prd_info1','U') IS NOT NULL  -- U for user and creating table related to product information--
	DROP TABLE silver.crm_prd_info1 ;

CREATE TABLE silver.crm_prd_info1 (
	prd_id INT,
	prd_key NVARCHAR(50),
	prd_nm NVARCHAR(50),
	prd_cost INT,
	prd_line NVARCHAR(50),
	prd_start_dt NVARCHAR(50), -- if the column has date we cannot directly add date datatype, instead use NVARCHAR--
	prd_end_dt NVARCHAR(50)     -- if the column has date we cannot directly add date datatype, instead use NVARCHAR--
	);

IF OBJECT_ID('silver.crm_sales_details1','U') IS NOT NULL  -- U for user and creating table related to sales information--
	DROP TABLE silver.crm_sales_details1 ;

CREATE TABLE silver.crm_sales_details1 (
	sls_ord_num NVARCHAR(50),
	sls_prd_key NVARCHAR(50),
	sls_cust_id INT,
	sls_order_dt NVARCHAR(50),    -- if the column has date we cannot directly add date datatype, instead use NVARCHAR--
	sls_ship_dt NVARCHAR(50),     -- if the column has date we cannot directly add date datatype, instead use NVARCHAR--
	sls_due_dt NVARCHAR(50),      -- if the column has date we cannot directly add date datatype, instead use NVARCHAR--
	sls_sales INT,
	sls_quantity INT,
	sls_price INT
	);

IF OBJECT_ID('silver.erp_loc_a101','U') IS NOT NULL  -- U for user and creating table related to custID& Country information--
	DROP TABLE silver.erp_loc_a101;

CREATE TABLE silver.erp_loc_a101 (
	cid NVARCHAR(50),
	cntry NVARCHAR(50)   -- table with no date -- 
	);

IF OBJECT_ID('silver.erp_cust_az12a','U') IS NOT NULL  -- U for user and creating table related to custID & bday information--
	DROP TABLE silver.erp_cust_az12a;

CREATE TABLE silver.erp_cust_az12a (
	cid NVARCHAR(50),
	bdate NVARCHAR(50),   -- if the column has date we cannot directly add date datatype, instead use NVARCHAR
	gen NVARCHAR(50)
	);
	
IF OBJECT_ID('silver.px_cat_g1v2','U') IS NOT NULL  -- U for user and creating table related to category information--
	DROP TABLE silver.px_cat_g1v2;

CREATE TABLE silver.px_cat_g1v2 (
	id NVARCHAR(50),
	cat NVARCHAR(50),
	subcat NVARCHAR(50),
	maintenance NVARCHAR(50)
	);

TRUNCATE TABLE silver.crm_cust_info1;	
BULK INSERT silver.crm_cust_info1
FROM 'D:\data with bara\datawarehouse\datawarehouse\sql-data-warehouse-project\datasets\source_crm\cust_info.csv'
WITH (
	FIRSTROW = 2,
	FIELDTERMINATOR = ',', -- run the load only once as we may get duplicate rows & columns -- 
	TABLOCK
	);

select * from silver.crm_cust_info1;
select cst_marital_status, count(*) from silver.crm_cust_info
group by cst_marital_status;
select cst_gndr, count(*) from silver.crm_cust_info
group by cst_gndr;

DROP TABLE silver.crm_cust_info;
CREATE TABLE silver.crm_cust_info (
	cst_id INT,
	cst_key NVARCHAR(50),
	cst_firstname NVARCHAR(50),
	cst_lastname NVARCHAR(50),
	cst_marital_status NVARCHAR(50),
	cst_gndr NVARCHAR(50),
	cst_create_date NVARCHAR(50), -- if the column has date we cannot directly add date datatype, instead use NVARCHAR--
	) ;
INSERT INTO silver.crm_cust_info
SELECT
    cst_id,
    cst_key,
    cst_firstname,
    cst_lastname,
    cst_marital_status,
    cst_gndr,
    TRY_CONVERT(DATE, cst_create_date, 105) -- based on the format in the excel we need to use the conversion --
FROM silver.crm_cust_info1;                 -- if we use dd-mm-yyyy format use conversion (TRY_CONVERT(DATE, cst_create_date, 105)--

select * from silver.crm_cust_info;

-- bulk upload of product information -- 
TRUNCATE TABLE silver.crm_prd_info1;	
BULK INSERT silver.crm_prd_info1
FROM 'D:\data with bara\datawarehouse\datawarehouse\sql-data-warehouse-project\datasets\source_crm\prd_info.csv'
WITH (
	FIRSTROW = 2,
	FIELDTERMINATOR = ',', -- run the load only once as we may get duplicate rows & columns -- 
	TABLOCK
	);
select * from silver.crm_prd_info1;

-- bulk upload of sales information -- 
TRUNCATE TABLE silver.crm_sales_details1;	
BULK INSERT silver.crm_sales_details1
FROM 'D:\data with bara\datawarehouse\datawarehouse\sql-data-warehouse-project\datasets\source_crm\sales_details.csv'
WITH (
	FIRSTROW = 2,
	FIELDTERMINATOR = ',', -- run the load only once as we may get duplicate rows & columns -- 
	TABLOCK
	);

	
DROP TABLE silver.crm_prd_info ;
CREATE TABLE silver.crm_prd_info (
	prd_id INT,
	prd_key NVARCHAR(50),
	prd_nm NVARCHAR(50),
	prd_cost INT,
	prd_line NVARCHAR(50),
	prd_start_dt NVARCHAR(50), -- if the column has date we cannot directly add date datatype, instead use NVARCHAR--
	prd_end_dt NVARCHAR(50)     -- if the column has date we cannot directly add date datatype, instead use NVARCHAR--
	);

TRUNCATE TABLE silver.crm_cust_info;

INSERT INTO silver.crm_prd_info
SELECT
    prd_id,
    prd_key,
    prd_nm,
    prd_cost,
    prd_line,
    TRY_CONVERT(DATE, prd_start_dt, 105),   -- if we use dd-mm-yyyy format use conversion (TRY_CONVERT(DATE, cst_create_date, 105)--
    TRY_CONVERT(DATE, prd_end_dt, 105) -- based on the format in the excel we need to use the conversion --
FROM silver.crm_prd_info1;  

DROP TABLE silver.crm_sales_details;
CREATE TABLE silver.crm_sales_details (
	sls_ord_num NVARCHAR(50),
	sls_prd_key NVARCHAR(50),
	sls_cust_id INT,
	sls_order_dt NVARCHAR(50),    -- if the column has date we cannot directly add date datatype, instead use NVARCHAR--
	sls_ship_dt NVARCHAR(50),     -- if the column has date we cannot directly add date datatype, instead use NVARCHAR--
	sls_due_dt NVARCHAR(50),      -- if the column has date we cannot directly add date datatype, instead use NVARCHAR--
	sls_sales INT,
	sls_quantity INT,
	sls_price INT
	);

INSERT INTO silver.crm_sales_details
SELECT
	sls_ord_num ,
	sls_prd_key ,
	sls_cust_id ,
	TRY_CONVERT(DATE, sls_order_dt, 112) ,    -- if the column has date we cannot directly add date datatype, instead use NVARCHAR--
	TRY_CONVERT(DATE, sls_ship_dt, 112) ,     -- if the column has date we cannot directly add date datatype, instead use NVARCHAR--
	TRY_CONVERT(DATE, sls_due_dt, 112) ,      -- if the column has date we cannot directly add date datatype, instead use NVARCHAR--
	sls_sales ,
	sls_quantity ,
	sls_price 
FROM silver.crm_sales_details1;

select * from silver.crm_sales_details;
TRUNCATE TABLE silver.crm_sales_details;

DROP TABLE silver.erp_cust_az12;
CREATE TABLE silver.erp_cust_az12 (
	cid NVARCHAR(50),
	bdate NVARCHAR(50),   -- if the column has date we cannot directly add date datatype, instead use NVARCHAR
	gen NVARCHAR(50)
	);

-- bulk upload of customer az12 information -- 
TRUNCATE TABLE silver.erp_cust_az12a;	
BULK INSERT silver.erp_cust_az12a
FROM 'D:\data with bara\datawarehouse\datawarehouse\sql-data-warehouse-project\datasets\source_erp\cust_az12.csv'
WITH (
	FIRSTROW = 2,
	FIELDTERMINATOR = ',', -- run the load only once as we may get duplicate rows & columns -- 
	TABLOCK
	);
select * from silver.erp_cust_az12a;

-- bulk upload of local a101 information -- 
TRUNCATE TABLE silver.erp_loc_a101;	
BULK INSERT silver.erp_loc_a101
FROM 'D:\data with bara\datawarehouse\datawarehouse\sql-data-warehouse-project\datasets\source_erp\loc_a101.csv'
WITH (
	FIRSTROW = 2,
	FIELDTERMINATOR = ',', -- run the load only once as we may get duplicate rows & columns -- 
	TABLOCK
	);
select * from silver.erp_loc_a101;

-- bulk upload of category information -- 
TRUNCATE TABLE silver.px_cat_g1v2;	
BULK INSERT silver.px_cat_g1v2
FROM 'D:\data with bara\datawarehouse\datawarehouse\sql-data-warehouse-project\datasets\source_erp\px_cat_g1v2.csv'
WITH (
	FIRSTROW = 2,
	FIELDTERMINATOR = ',', -- run the load only once as we may get duplicate rows & columns -- 
	TABLOCK
	);
select * from silver.px_cat_g1v2;

INSERT INTO silver.erp_cust_az12
SELECT
	cid,
	TRY_CONVERT(DATE, bdate, 105),   -- if we use dd-mm-yyyy format use conversion (TRY_CONVERT(DATE, cst_create_date, 105)--
	gen
FROM silver.erp_cust_az12a;




ALTER TABLE silver.crm_cust_info
ADD dwh_create_date DATETIME2 NOT NULL DEFAULT SYSDATETIME();

select * from silver.crm_cust_info;

ALTER TABLE silver.crm_prd_info
ADD dwh_create_date DATETIME2 NOT NULL DEFAULT SYSDATETIME();

select * from silver.crm_prd_info;
TRUNCATE TABLE silver.crm_prd_info;
ALTER TABLE silver.crm_sales_details
ADD dwh_create_date DATETIME2 NOT NULL DEFAULT SYSDATETIME();

select * from silver.crm_sales_details;

ALTER TABLE silver.erp_cust_az12
ADD dwh_create_date DATETIME2 NOT NULL DEFAULT SYSDATETIME();

select * from silver.erp_cust_az12;
TRUNCATE TABLE silver.erp_cust_az12;

ALTER TABLE silver.erp_loc_a101
ADD dwh_create_date DATETIME2 NOT NULL DEFAULT SYSDATETIME();

select * from silver.erp_loc_a101;

ALTER TABLE silver.px_cat_g1v2
ADD dwh_create_date DATETIME2 NOT NULL DEFAULT SYSDATETIME();

select * from silver.px_cat_g1v2;

-- load data by cleaning the bronze layer and insert it into silver layer -- 

-- data quality checks -- 

SELECT cst_id , count(*)
FROM bronze.crm_cust_info
group by cst_id
having count(*) > 1;

-- assign unique number to each row -- (ROW_NUMBER) -- hard coding--

SELECT * , ROW_NUMBER() OVER (PARTITION BY cst_id ORDER BY cst_create_date DESC) as FLAG
FROM bronze.crm_cust_info
WHERE cst_id = 29473;

-- common --
SELECT *
FROM
(
SELECT * , ROW_NUMBER() OVER (PARTITION BY cst_id ORDER BY cst_create_date DESC) as FLAG
FROM bronze.crm_cust_info
WHERE cst_id is not null
) t
WHERE FLAG =1;

-- DATA STANDARDIZATION & Consistency --
-- check for unwanted spaces in the string value -- 

SELECT cst_firstname
FROM bronze.crm_cust_info
WHERE cst_firstname != TRIM(cst_firstname);

-- Insert data from bronze to silver --

INSERT INTO silver.crm_cust_info (
	cst_id,
	cst_key,
	cst_firstname,
	cst_lastname,
	cst_marital_status,
	cst_gndr,
	cst_create_date
	)
	SELECT cst_id,
	cst_key,
	TRIM(cst_firstname) as cst_firstname,
	TRIM(cst_lastname) as cst_lastname,
	CASE 
	WHEN UPPER(TRIM(cst_marital_status)) = 'M' THEN 'Married'
	WHEN UPPER(TRIM(cst_marital_status)) = 'S' THEN 'Single'
	ELSE 'N/A'
	END as cst_marital_status,
	CASE 
	WHEN UPPER(TRIM(cst_gndr)) = 'M' THEN 'Male'
	WHEN UPPER(TRIM(cst_gndr)) = 'F' THEN 'Female'
	ELSE 'N/A'
	END as cst_gndr,
	cst_create_date
	FROM 
	(
	SELECT *,
	ROW_NUMBER() OVER(PARTITION BY cst_id ORDER BY cst_create_date DESC) as FLAG
	FROM bronze.crm_cust_info
	WHERE cst_id IS NOT NULL
	)t
	WHERE FLAG = 1;

select * from silver.crm_cust_info;
